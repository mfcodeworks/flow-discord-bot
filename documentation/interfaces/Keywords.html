<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>nr-wallet-discord-bot documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	      <link rel="stylesheet" href="../styles/style.css">
    </head>
    <body>

        <div class="navbar navbar-default navbar-fixed-top visible-xs">
            <a href="../" class="navbar-brand">nr-wallet-discord-bot documentation</a>
            <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="hidden-xs menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content interface">
                   <div class="content-data">












<ol class="breadcrumb">
  <li>Interfaces</li>
  <li>Keywords</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="active">
            <a href="#info" role="tab" id="info-tab" data-toggle="tab" data-link="info">Info</a>
        </li>
        <li >
            <a href="#source" role="tab" id="source-tab" data-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="c-info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>src/discord/services/discord/discord.service.ts</code>
        </p>



        <section>
            <h3 id="index">Index</h3>
            <table class="table table-sm table-bordered index-table">
                <tbody>
                    <tr>
                        <td class="col-md-4">
                            <h6><b>Properties</b></h6>
                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                            <ul class="index-list">
                                <li>
                                        <a href="#action">action</a>
                                </li>
                                <li>
                                        <a href="#currency">currency</a>
                                </li>
                            </ul>
                        </td>
                    </tr>
                </tbody>
            </table>
        </section>



            <section>
                <h3 id="inputs">Properties</h3>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="action"></a>
                                        <span class="name"><b>action</b><a href="#action"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>action:     <code>string[]</code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>    <code>string[]</code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="currency"></a>
                                        <span class="name"><b>currency</b><a href="#currency"><span class="icon ion-ios-link"></span></a></span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>currency:     <code>string[]</code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>    <code>string[]</code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
            </section>
    </div>


    <div class="tab-pane fade  tab-source-code" id="c-source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import { Injectable } from &#x27;@nestjs/common&#x27;;
import { Client, RichEmbed, Message, Attachment, User, DMChannel } from &#x27;discord.js&#x27;
import { SHA256, enc } from &#x27;crypto-js&#x27;
import accounting from &#x27;accounting&#x27;
import config from &#x27;config&#x27;
import { Colours } from &#x27;../../core/colours.enum&#x27;
import { Profile } from &#x27;../../../shared/core/profile&#x27;
import { Transaction } from &#x27;../../../shared/core/transaction&#x27;;
import { ProfileService } from &#x27;../../../shared/services/profile/profile.service&#x27;;
import { TransactionService } from &#x27;../../../shared/services/transaction/transaction.service&#x27;;
import { Args } from &#x27;../../core/args&#x27;;

interface Keywords {
    currency: string[];
    action: string[];
}

@Injectable()
export class DiscordService {
    public client: Client
    private static readonly colours &#x3D; Colours
    private static readonly keywords: Keywords &#x3D; {
        currency: [
            &#x27;usd&#x27;,
            &#x27;sgd&#x27;
        ], action: [
            &#x27;split&#x27;,
            &#x27;each&#x27;
        ]
    }

    constructor(
        private _profile: ProfileService,
        private _transaction: TransactionService
    ) {
        // Create client
        this.client &#x3D; new Client()

        // On client ready
        this.client.once(&#x27;ready&#x27;, this.onReady.bind(this))

        // On message recieved handle return
        this.client.on(&#x27;message&#x27;, this.onMessage.bind(this))

        // Client login
        this.client.login(config.get(&#x27;discord_token&#x27;))
    }

    private onReady(): void {
        // Log ready
        console.log(&#x27;Discord monitor running&#x27;)
    }

    private async onMessage(message: Message): Promise&lt;Message | Message[]&gt; {
        let user: Profile
        const args &#x3D; new Args(message.content)
        console.log(&#x27;Received&#x27;, args)

        switch (args[0]) {
            case &#x27;$help&#x27;:
                message.channel.send(
                    &#x27;** NR Wallet Commands **\n\n&#x27; +
                    &#x27;&#x60;$currencies&#x60; View accepted currencies\n\n&#x27; +
                    &#x27;&#x60;$currencys&#x60; Same as &#x60;$currencies&#x60;\n\n&#x27; +
                    &#x27;&#x60;$link&#x60; Link with NR Wallet to begin sending and receiving\n\n&#x27; +
                    &#x27;&#x60;$balance&#x60; View linked wallet balance\n\n&#x27; +
                    &#x27;&#x60;$send @user1 [@user2] amount currency [[each] [split]]&#x60; Send some money to someone\n\n&#x27; +
                    &#x27;&#x60;$confirm&#x60; Confirm your transaction before we send it out\n\n&#x27; +
                    &#x27;&#x60;$source [source]&#x60; View and set available payment sources (&#x60;$source&#x60; to view &#x60;$source [source]&#x60; to set)\n\n&#x27; +
                    &#x27;&#x60;$sauce&#x60; Same as &#x60;$source&#x60;\n\n&#x27; +
                    &#x27;&#x60;$wallet&#x60; Get a link to your NR Wallet\n\n&#x27; +
                    &#x27;*Ex: $send @nygmarose @knightofhonour 13.37 SGD each*&#x27;
                )
                break

            case &#x27;$currencies&#x27;:
            case &#x27;$currencys&#x27;:
                message.channel.send(&#x60;Currently NR Wallet accepts: ${DiscordService.keywords.currency.map((c: string) &#x3D;&gt; c.toUpperCase()).join(&#x27;, &#x27;)}&#x60;)
                break

            case &#x27;$link&#x27;:
                user &#x3D; await this._profile.get(message.author.id)

                // If user is linked reply with status
                if (user.linked) {
                    return message.reply(&#x60;It looks like you&#x27;re already linked up&#x60;)
                }

                // Create DM channel
                const channel &#x3D; await message.author.createDM()

                // Send link to channel
                if (channel) {
                    channel.send(
                        new RichEmbed()
                            .setTitle(&#x27;NR Wallet Login Link&#x27;)
                            .setDescription(&#x60;Hey ${message.author.toString()}, you can link your wallet here. You&#x27;ll be asked to login and then you&#x27;ll be directed back to our website once your account is linked! Just click the title right there.&#x60;)
                            .setColor(DiscordService.colours.info)
                            .setURL(&#x60;${config.get(&#x27;wallet.endpoint&#x27;)}/oauth/authorize?client_id&#x3D;${config.get(&#x27;wallet.client&#x27;)}&amp;redirect_uri&#x3D;${config.get(&#x27;wallet.redirect_uri&#x27;)}&amp;response_type&#x3D;code&amp;scope&#x3D;${config.get(&#x27;wallet.scope&#x27;)}&amp;state&#x3D;${message.author.id},${SHA256(message.author.id, config.get(&#x27;wallet.secret&#x27;)).toString(enc.Hex)}&#x60;)
                            .setThumbnail(&#x27;https://glamsquad.sgp1.cdn.digitaloceanspaces.com/SocialHub/default/images/Logo_Transparent%20White.png&#x27;)
                    )

                    // Send confirmation if guild
                    if (message.guild) {
                        message.reply(&#x60;You got it, I DM&#x27;d you the link&#x60;)
                    }
                    return
                }

                // Send error if no channel
                message.reply(&#x60;Hey uhm, I couldn&#x27;t DM you, can you make sure I&#x27;m not blocked or anything?&#x60;)
                break

            case &#x27;$balance&#x27;:
                user &#x3D; await this._profile.get(message.author.id)

                // Check if user is linked
                if (!this.linkCheck(user, message)) return

                // TODO: Update user balance

                // Send users available and pending balance
                message.reply(&#x60;Available balance: ${user.balance.available} ${user.currency}\nPending balance: ${user.balance.pending} ${user.currency}&#x60;)
                break

            case &#x27;$wallet&#x27;:
                user &#x3D; await this._profile.get(message.author.id)

                // Check if user is linked
                if (!this.linkCheck(user, message)) return

                message.reply(
                    new RichEmbed()
                        .setTitle(&#x27;NR Wallet&#x27;)
                        .setDescription(&#x60;Hey ${message.author.toString()}, you can check your full wallet here. You&#x27;ll be sent to NR Wallet online, or you can open the app directly if it&#x27;s installed! Just click the title right there.&#x60;)
                        .setColor(DiscordService.colours.success)
                        .setURL(config.get(&#x27;wallet.app&#x27;))
                        .setThumbnail(&#x27;https://glamsquad.sgp1.cdn.digitaloceanspaces.com/SocialHub/default/images/Logo_Transparent%20White.png&#x27;)
                )
                break

            case &#x27;$send&#x27;:
                user &#x3D; await this._profile.get(message.author.id)

                // Check if user is linked
                if (!this.linkCheck(user, message)) return

                // Check if DM or group
                if (!message.guild) {
                    return message.reply(&#x60;Hey ${message.author.toString()}, I&#x27;ll need you to do that in a group to send to someone&#x60;)
                }

                // Create transaction
                const transaction &#x3D; new Transaction(message)

                // Get currency mentioned
                transaction.currency &#x3D; args.findKeyword(this.getKeywords(&#x27;currency&#x27;), 1)
                if (!transaction.currency) {
                    return message.reply(&#x60;Awesome. Now, can you send that again with a currency?&#x60;)
                }

                // Get amount mentioned
                transaction.amount &#x3D; args.findFirstNumber(1)
                if (!transaction.amount) {
                    return message.reply(&#x60;Uhhh I couldn&#x27;t see any amount there&#x60;)
                }

                // Format amount to decimal number
                transaction.amount &#x3D; DiscordService.formatCurrency(transaction.amount as number, transaction.currency as string)

                // TODO: Convert currencies if needed (transaction.amount -&gt; user.source.default)

                // Get users mentioned
                transaction.users &#x3D; message.mentions.users.array().filter(u &#x3D;&gt; u.id !&#x3D;&#x3D; message.author.id &amp;&amp; !u.bot &amp;&amp; !!message.guild.member(u)).map(u &#x3D;&gt; u.id)

                if (!transaction.users.length) {
                    return message.reply(&#x60;That would be awesome but I couldn&#x27;t see anyone to send to, make sure you mention them *and* they&#x27;re in this group&#x60;)
                }

                // Check if users are all linked
                const profiles: Profile[] &#x3D; await Promise.all(
                   transaction.users.map(u &#x3D;&gt; this._profile.get(u))
                )
                const unlinked: Profile[] &#x3D; profiles.filter((p: Profile) &#x3D;&gt; !p.linked)
                if (unlinked.length) {
                    return message.reply(&#x60;${unlinked.length &gt; 1 ? &#x27;These users&#x27; : &#x27;This user&#x27;} hasn&#x27;t linked an account: ${unlinked.map((u: Profile) &#x3D;&gt; &#x60;&lt;@${u.id}&gt;&#x60;).join(&#x27;, &#x27;)}&#x60;)
                }

                // If multiple users check for action to perform
                if (transaction.users.length &gt; 1) {
                    transaction.action &#x3D; args.findKeyword(this.getKeywords(&#x27;action&#x27;), 1)
                    if (!transaction.action) {
                        return message.reply(&#x60;Can you copy paste that message but let me know if I should send then ${transaction.amount} ${transaction.currency} \&#x60;each\&#x60; or should I \&#x60;split\&#x60; between them&#x60;)
                    }
                }

                // Save transaction
                this._transaction.save(transaction)

                // Return confirmation message
                return message.reply(transaction.toString())

            case &#x27;$confirm&#x27;:
                // Check not a DM
                if (!message.guild) {
                    return message.reply(&#x60;Well you can&#x27;t pay me so I don&#x27;t have a transaction for this DM&#x60;)
                }

                user &#x3D; await this._profile.get(message.author.id)

                // Check if user is linked
                if (!this.linkCheck(user, message)) return

                // Get pending transaction
                const confirmation &#x3D; await this._transaction.get(message)

                // Return an error if no pending transaction
                if (!confirmation) {
                    return message.reply(&#x27;Sure thing! I couldn\&#x27;t find anything to confirm though.&#x27;)
                }

                // TODO: Send out the money
                // transaction.execute()

                // DM the recipients
                confirmation.users.forEach((u: string | User) &#x3D;&gt; {
                    u &#x3D; this.client.users.find(&#x27;id&#x27;, u)
                    u.createDM().then((c: DMChannel) &#x3D;&gt; {
                        c.send(&#x60;Hey ${u.toString()}! ${this.client.users.find(&#x27;id&#x27;, confirmation.sender).username} sent a full ${confirmation.amount} ${confirmation.currency} to your NR Wallet!&#x60;)
                    })
                })

                // Confirm with the sender
                message.reply(&#x27;Will do. Everything\&#x27;s been sent out and everyone DM\&#x27;d&#x27;)
                break

            case &#x27;$source&#x27;:
            case &#x27;$sauce&#x27;:
                user &#x3D; await this._profile.get(message.author.id)

                // Check if user is linked
                if (!this.linkCheck(user, message)) return

                // Send warning if guild
                if (message.guild) {
                    message.reply(&#x60;Shhh... we shouldn&#x27;t talk about that here&#x60;)
                }

                // TODO: Get sources and send to DM
                break
        }
    }

    public async authorised(user: Profile): Promise&lt;Message | Message[]&gt; {
        const profile &#x3D; this.client.users.find(u &#x3D;&gt; u.id &#x3D;&#x3D; user.id)
        const dm &#x3D; await profile.createDM()
        return dm.send(&#x60;Awesome ${profile.toString()}, we&#x27;ve successfully linked your account!&#x60;)
    }

    private linkCheck(user: Profile, message: Message): boolean {
        if (!user.linked) {
            message.reply(&#x60;It looks like you haven&#x27;t linked an account yet! Use \&#x60;$link\&#x60; to link with your NR Wallet account&#x60;)
        }
        return user.linked
    }

    private getKeywords(type?: keyof Keywords): string[] {
        if (!type) {
            // eslint-disable-next-line @typescript-eslint/no-unused-vars
            return Array.prototype.concat(...Object.entries(DiscordService.keywords).map(([key, value]) &#x3D;&gt; value))
        }
        return DiscordService.keywords[type] || []
    }

    // Reply with an unauthorised message
    private unauthorised(message: Message): Promise&lt;Message | Message[]&gt; {
        return message.reply(new Attachment(&#x60;I&#x27;m sorry ${message.author.toString()}, I can&#x27;t do that&#x60;, &#x27;https://media1.tenor.com/images/86937766f3f44884362c716e8f1d0e19/tenor.gif&#x27;))
    }

    // Format currency input
    private static formatCurrency(value: number, currency: string): number {
        if ([&#x27;EUR&#x27;].includes(currency)) {
            return accounting.unformat(value.toString(), &#x27;,&#x27;)
        } else {
            return accounting.unformat(value.toString())
        }
    }
}
</code></pre>
    </div>
</div>


                   




                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> result-matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'interface';
            var COMPODOC_CURRENT_PAGE_URL = 'Keywords.html';
            var MAX_SEARCH_RESULTS = 15;
       </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>
       <!-- Required to polyfill modern browsers as code is ES5 for IE... -->
       <script src="../js/libs/custom-elements-es5-adapter.js" charset="utf-8" defer></script>
       <script src="../js/menu-wc.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>
       <script src="../js/libs/zepto.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
